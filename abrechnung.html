<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abrechnung (Offline)</title>
    <link rel="stylesheet" href="style.css">
    <!-- Zentrales Auto-Sync Skript einbinden -->
    <script type="module" src="auto-sync.js" defer></script>
    <style>
        /* Zusätzliche Stile für die Abrechnungsseite */
        #abrechnung main h2 {
            margin-bottom: 20px;
        }
        #summenAnzeige {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 5px;
            display: inline-block; /* Passt sich der Breite des Inhalts an */
        }
        #summenAnzeige span {
            color: #28a745; /* Grüne Farbe für die Summe */
        }
        #teamAbrechnungListe {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #teamAbrechnungListe li {
            padding: 12px 15px;
            border: 1px solid #ddd;
            margin-bottom: -1px; /* Verhindert doppelte Ränder */
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            flex-wrap: wrap; /* Erlaubt Umbruch bei schmalen Bildschirmen */
        }
        #teamAbrechnungListe li:first-child {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        #teamAbrechnungListe li:last-child {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            margin-bottom: 0;
        }

        .team-info {
            display: flex;
            align-items: center;
            flex-grow: 1; /* Nimmt verfügbaren Platz ein */
            margin-right: 15px; /* Abstand zu den Controls */
        }

        .team-controls {
            display: flex;
            align-items: center;
            gap: 15px; /* Abstand zwischen den Controls */
        }

        .team-controls label {
             display: flex;
             align-items: center;
             cursor: pointer;
             white-space: nowrap; /* Verhindert Umbruch im Label */
        }

        .team-controls input[type="checkbox"] {
            margin-right: 5px; /* Kleinerer Abstand zur Beschriftung */
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .team-controls select {
            padding: 4px 8px;
            cursor: pointer;
            min-width: 50px; /* Mindestbreite für das Dropdown */
        }

        .team-summe {
            font-weight: bold;
            margin-left: 15px; /* Abstand zu den Controls */
            white-space: nowrap;
            min-width: 60px; /* Mindestbreite für die Summe */
            text-align: right;
        }

        /* Hervorhebung, wenn Startgeld bezahlt wurde */
        #teamAbrechnungListe li.startgeld-bezahlt .team-info span {
             /* Optional: Leichte Hervorhebung, z.B. fetter oder andere Farbe */
             /* font-weight: bold; */
        }

        .sync-status-indicator { /* Wiederverwendet von style.css */
             font-size: 0.8em;
             margin-left: 8px;
             color: orange;
             font-style: italic;
        }

         /* Responsive Anpassung */
         @media (max-width: 768px) {
            #teamAbrechnungListe li {
                flex-direction: column; /* Untereinander auf kleinen Screens */
                align-items: flex-start; /* Links ausrichten */
            }
            .team-controls {
                margin-top: 10px; /* Abstand nach oben */
                width: 100%; /* Volle Breite nutzen */
                justify-content: space-between; /* Controls verteilen */
            }
            .team-summe {
                 margin-left: 0; /* Kein linker Rand mehr */
                 margin-top: 5px; /* Abstand nach oben */
                 align-self: flex-end; /* Summe rechts ausrichten */
            }
         }

    </style>
</head>
<body id="abrechnung">
    <header>
        <h1>Schützenverein - Abrechnung</h1>
    </header>
    <div class="container">
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="teilnehmer.html">Teilnehmer anlegen</a></li>
                <li><a href="teams.html">Teams anlegen</a></li>
                <li><a href="zuordnung.html">Teamzuordnung</a></li>
                <li><a href="ergebnisErfassen.html">Ergebnisse erfassen</a></li>
                <li><a href="ergebnisseAusgeben.html">Ergebnisse ausgeben</a></li>
                <li><a href="statistik.html">Statistik</a></li>
                <li><a href="scheibenErfassen.html">Scheiben erfassen</a></li>
                <li><a href="abrechnung.html" class="aktiv">Abrechnung</a></li> {/* Aktiv markiert */}
                <li><a href="adminOnly.html">Admin</a></li>
            </ul>
        </nav>
        <main>
            <h2>Abrechnung Startgeld & Nachlösungen</h2>

            <div id="statusMeldung" class="status-meldung"></div>
            <div id="ladeAnzeige" class="lade-anzeige">
                <div class="lade-kreis"></div>
                <p>Lade Teamdaten und Zahlungsstatus...</p>
            </div>

            <div id="summenAnzeige">
                Gesamteinnahmen: <span id="gesamtSumme">0.00 €</span>
            </div>

            <h3>Teams</h3>
            <ul id="teamAbrechnungListe">
                <!-- Teamliste wird hier dynamisch eingefügt -->
                <li>Keine Teams gefunden.</li>
            </ul>
        </main>
    </div>

    <script type="module">
        import { getLocalData, setLocalData, TEAMS_KEY } from './local-storage-utils.js';
        import { zeigeStatus } from './ui-utils.js';

        // Konfiguration
        const STARTGELD_BASIS = 12; // Kosten für die erste Teilnahme
        const STARTGELD_NACHLOESUNG = 6; // Kosten pro Nachlösung
        const MAX_NACHLOESUNGEN = 5; // Maximale Anzahl an Nachlösungen
        const PAYMENT_STATUS_KEY = 'paymentStatus_v2'; // Neuer Key für die geänderte Struktur

        // DOM Elemente
        const teamListeUl = document.getElementById('teamAbrechnungListe');
        const gesamtSummeSpan = document.getElementById('gesamtSumme');
        const ladeAnzeige = document.getElementById('ladeAnzeige');
        const statusMeldung = document.getElementById('statusMeldung');

        // Lokaler Cache für Zahlungsstatus
        // Format: { teamLocalId1: { basePaid: boolean, rebuys: number }, teamLocalId2: {...}, ... }
        let paymentStatus = {};

        function zeigeLoader(anzeigen) {
            if (ladeAnzeige) ladeAnzeige.style.display = anzeigen ? "block" : "none";
        }

        // Berechnet die Summe für ein einzelnes Team
        function berechneTeamSumme(status) {
            const baseCost = status.basePaid ? STARTGELD_BASIS : 0;
            const rebuyCost = (status.rebuys || 0) * STARTGELD_NACHLOESUNG;
            return baseCost + rebuyCost;
        }

        // Lädt Teams und Zahlungsstatus, zeigt die Liste an
        function loadAndDisplayData() {
            zeigeLoader(true);
            teamListeUl.innerHTML = '<li>Lade Daten...</li>'; // Platzhalter

            try {
                // 1. Teams laden
                const lokaleTeams = getLocalData(TEAMS_KEY);
                const aktiveTeams = lokaleTeams.filter(t => t._syncStatus !== 'deleted');
                aktiveTeams.sort((a, b) => (a.teamname || "").localeCompare(b.teamname || ""));

                // 2. Zahlungsstatus laden (oder initialisieren)
                paymentStatus = getLocalData(PAYMENT_STATUS_KEY) || {};

                // 3. Liste generieren
                teamListeUl.innerHTML = ""; // Liste leeren

                if (aktiveTeams.length === 0) {
                    teamListeUl.innerHTML = "<li>Keine aktiven Teams vorhanden.</li>";
                    berechneUndZeigeGesamtSumme(); // Summe trotzdem aktualisieren (sollte 0 sein)
                    zeigeLoader(false);
                    return;
                }

                aktiveTeams.forEach(team => {
                    const li = document.createElement('li');
                    const teamLocalId = team.localId;
                    // Hole Status oder setze Default, falls Team neu ist
                    const currentStatus = paymentStatus[teamLocalId] || { basePaid: false, rebuys: 0 };

                    li.dataset.localId = teamLocalId;
                    if (currentStatus.basePaid) {
                        li.classList.add('startgeld-bezahlt'); // Klasse für bezahltes Startgeld
                    }

                    // Sync-Status Text (optional)
                    let syncStatusText = '';
                     if (team._syncStatus && team._syncStatus !== 'synced') {
                         syncStatusText = `<span class="sync-status-indicator">(${team._syncStatus})</span>`;
                     }

                    // Optionen für Nachlösungs-Dropdown generieren
                    let rebuyOptionsHtml = '';
                    for (let i = 0; i <= MAX_NACHLOESUNGEN; i++) {
                        rebuyOptionsHtml += `<option value="${i}" ${currentStatus.rebuys === i ? 'selected' : ''}>${i}</option>`;
                    }

                    // Team-Summe berechnen
                    const teamSumme = berechneTeamSumme(currentStatus);

                    li.innerHTML = `
                        <div class="team-info">
                            <span>${team.teamname || 'Unbenanntes Team'}</span>
                            ${syncStatusText}
                        </div>
                        <div class="team-controls">
                            <label>
                                <input type="checkbox" class="base-paid-check" ${currentStatus.basePaid ? 'checked' : ''}>
                                Startgeld (${STARTGELD_BASIS.toFixed(2)} €)
                            </label>
                            <label>
                                Nachlösungen (${STARTGELD_NACHLOESUNG.toFixed(2)} €):
                                <select class="rebuy-select">
                                    ${rebuyOptionsHtml}
                                </select>
                            </label>
                        </div>
                        <span class="team-summe">${teamSumme.toFixed(2)} €</span>
                    `;

                    // Event Listener für Checkbox und Select hinzufügen
                    const checkbox = li.querySelector('.base-paid-check');
                    const select = li.querySelector('.rebuy-select');

                    checkbox.addEventListener('change', () => handlePaymentChange(teamLocalId, li));
                    select.addEventListener('change', () => handlePaymentChange(teamLocalId, li));

                    teamListeUl.appendChild(li);
                });

                // 4. Initiale Gesamtsumme berechnen und anzeigen
                berechneUndZeigeGesamtSumme();

            } catch (error) {
                console.error("Fehler beim Laden der Abrechnungsdaten:", error);
                zeigeStatus("Fehler beim Laden der Daten. Details siehe Konsole.", 'fehler', statusMeldung);
                teamListeUl.innerHTML = "<li>Fehler beim Laden der Teams.</li>";
            } finally {
                zeigeLoader(false);
            }
        }

        // Wird aufgerufen, wenn eine Checkbox oder ein Select geändert wird
        function handlePaymentChange(teamLocalId, listItem) {
            const checkbox = listItem.querySelector('.base-paid-check');
            const select = listItem.querySelector('.rebuy-select');

            const newBasePaid = checkbox.checked;
            const newRebuys = parseInt(select.value);

            // Alten Status sichern, falls Speichern fehlschlägt
            const oldStatus = { ...(paymentStatus[teamLocalId] || { basePaid: false, rebuys: 0 }) };

            // 1. Status im lokalen Cache aktualisieren
            paymentStatus[teamLocalId] = { basePaid: newBasePaid, rebuys: newRebuys };

            // 2. Aktualisierten Status im Local Storage speichern
            const success = setLocalData(PAYMENT_STATUS_KEY, paymentStatus);

            if (success) {
                // 3. UI aktualisieren
                // Klasse für bezahltes Startgeld
                if (newBasePaid) {
                    listItem.classList.add('startgeld-bezahlt');
                } else {
                    listItem.classList.remove('startgeld-bezahlt');
                }
                // Team-Summe aktualisieren
                const teamSumme = berechneTeamSumme(paymentStatus[teamLocalId]);
                listItem.querySelector('.team-summe').textContent = `${teamSumme.toFixed(2)} €`;

                // Gesamtsumme neu berechnen
                berechneUndZeigeGesamtSumme();

                // Kurze Erfolgsmeldung (optional)
                // zeigeStatus(`Zahlungsstatus für Team aktualisiert.`, 'info', statusMeldung, 2000);
            } else {
                // Fehler beim Speichern
                zeigeStatus("Fehler beim Speichern des Zahlungsstatus!", 'fehler', statusMeldung);

                // UI und Cache auf alten Wert zurücksetzen
                paymentStatus[teamLocalId] = oldStatus; // Cache zurücksetzen
                checkbox.checked = oldStatus.basePaid;
                select.value = oldStatus.rebuys;

                 // Klasse und Team-Summe auch zurücksetzen
                if (oldStatus.basePaid) {
                    listItem.classList.add('startgeld-bezahlt');
                } else {
                    listItem.classList.remove('startgeld-bezahlt');
                }
                const teamSumme = berechneTeamSumme(oldStatus);
                listItem.querySelector('.team-summe').textContent = `${teamSumme.toFixed(2)} €`;

                // Gesamtsumme muss nicht neu berechnet werden, da nichts gespeichert wurde
            }
        }

        // Berechnet die Gesamtsumme basierend auf dem 'paymentStatus' Objekt
        function berechneUndZeigeGesamtSumme() {
            let gesamtSumme = 0;
            const lokaleTeams = getLocalData(TEAMS_KEY); // Hole aktuelle Teams für die Berechnung

            // Gehe durch alle *aktiven* Teams
            lokaleTeams.filter(t => t._syncStatus !== 'deleted').forEach(team => {
                 // Hole den Status für das Team aus dem Cache
                 const status = paymentStatus[team.localId] || { basePaid: false, rebuys: 0 };
                 // Addiere die berechnete Summe für dieses Team hinzu
                 gesamtSumme += berechneTeamSumme(status);
            });

            // Formatieren und anzeigen
            gesamtSummeSpan.textContent = `${gesamtSumme.toFixed(2)} €`;
        }

        // Initialisierung beim Laden der Seite
        document.addEventListener('DOMContentLoaded', () => {
            loadAndDisplayData();

            // Optional: Listener für Storage-Events
            window.addEventListener('storage', (event) => {
                if (event.key === TEAMS_KEY || event.key === PAYMENT_STATUS_KEY) {
                    console.log('LocalStorage geändert (Teams/Payment), lade Abrechnung neu...');
                    loadAndDisplayData();
                }
            });

            // Optional: Listener für erfolgreichen Sync
            window.addEventListener('datasync-complete', () => {
                console.log('Datensynchronisation abgeschlossen, lade Abrechnung neu...');
                loadAndDisplayData();
            });
        });

    </script>
</body>
</html>
