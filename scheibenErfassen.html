<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scheiben erfassen</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Zentrales Auto-Sync Skript einbinden -->
    <script type="module" src="auto-sync.js" defer></script>
    <!-- NEU: Skript zum Laden der Navigation einbinden -->
    <script src="load-nav.js" defer></script>

    <style>
      #scheibenAnzahlForm {
        margin-bottom: 20px;
      }
      #scheibenAnzahlForm label {
        margin-right: 10px;
      }
      #scheibenAnzahlForm input {
        width: 50px;
      }
      #scheibenAnzahlForm button {
        padding: 5px 10px;
      }
      #scheibenErfassung {
        display: none;
      }
      #scheibenContainer {
        margin-top: 20px;
      }
      #scheibenTabelle {
        width: auto; /* Nicht mehr 100% breit */
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 14px; /* Kleinere Schrift */
      }
      #scheibenTabelle th,
      #scheibenTabelle td {
        border: 1px solid #ddd;
        padding: 2px 8px; /* Oben/unten 2px, links/rechts 8px */
        text-align: left;
      }
      #scheibenTabelle th {
        background-color: #f0f0f0;
        padding: 3px 8px; /* Etwas mehr Padding für Überschriften */
      }
      #scheibenTabelle td:first-child {
        width: 60px; /* Feste Breite für die Scheiben-Nummer */
        text-align: center; /* Zentrierte Nummerierung */
      }
      #scheibenTabelle td:last-child {
        width: 80px; /* Feste Breite für den Wert */
        text-align: right; /* Rechtsbündige Zahlen */
      }
      /* NEU: Stil für Speicher-Button und Statusmeldung */
      #speichernBtn {
          margin-top: 20px;
      }
      .status-meldung {
          padding: 10px;
          margin-top: 15px; /* Abstand nach oben */
          margin-bottom: 15px;
          border-radius: 4px;
          display: none; /* Standardmäßig ausblenden */
      }
      .status-meldung.erfolg {
          background-color: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
      }
      .status-meldung.fehler {
          background-color: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
      }
      .status-meldung.info {
          background-color: #d1ecf1;
          color: #0c5460;
          border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Scheiben erfassen</h1>
    </header>
    <div class="container">
      <div id="navigation-placeholder">
        <!-- Die Navigation wird hier von load-nav.js eingefügt -->
      </div>
      <main>
        <h2>Scheiben erfassen</h2>

        <!-- NEU: Statusmeldung-Container -->
        <div id="statusMeldung" class="status-meldung"></div>

        <form id="scheibenAnzahlForm">
          <label for="anzahlScheiben">Anzahl Scheiben:</label>
          <input type="number" id="anzahlScheiben" min="1" value="1" required />
          <button type="submit">Bestätigen</button>
        </form>

        <div id="scheibenErfassung">
          <h3>Scheiben-Daten</h3>
          <!-- TODO: Hier Dropdowns für Teilnehmer/Team hinzufügen -->
          <!-- Beispiel:
          <label for="scheibenTeilnehmerSelect">Teilnehmer:</label>
          <select id="scheibenTeilnehmerSelect" required>
              <option value="">-- Teilnehmer wählen --</option>
          </select>
          -->
          <table id="scheibenTabelle">
            <thead>
              <tr>
                <th>Scheibe</th>
                <th>Wert</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th>Gesamt</th>
                <td id="gesamtSumme"></td>
              </tr>
              <tr>
                <th>Durchschnitt</th>
                <td id="durchschnittSumme"></td>
              </tr>
            </tfoot>
          </table>
          <!-- NEU: Speicher-Button -->
          <button id="speichernBtn" class="btn btn-primary">Scheibenwerte speichern</button>
        </div>
      </main>
    </div>
    <!-- NEU: Skript als Modul -->
    <script type="module">
      // NEU: Imports für Local Storage und UI Utils
      import { getLocalData, setLocalData, generateLocalId, SCHEIBEN_KEY, TEILNEHMER_KEY } from './local-storage-utils.js';
      import { zeigeStatus } from './ui-utils.js';

      document.addEventListener("DOMContentLoaded", () => {
        const anzahlForm = document.getElementById("scheibenAnzahlForm");
        const anzahlInput = document.getElementById("anzahlScheiben");
        const erfassungsDiv = document.getElementById("scheibenErfassung");
        const tabelleBody = document.querySelector("#scheibenTabelle tbody");
        const gesamtSummeTd = document.getElementById("gesamtSumme");
        const durchschnittSummeTd = document.getElementById("durchschnittSumme");
        const speichernBtn = document.getElementById('speichernBtn'); // NEU
        const statusMeldung = document.getElementById('statusMeldung'); // NEU
        // TODO: const teilnehmerSelect = document.getElementById('scheibenTeilnehmerSelect');

        // TODO: Teilnehmer-Dropdown füllen
        /*
        function ladeTeilnehmer() {
            const teilnehmer = getLocalData(TEILNEHMER_KEY)
                                .filter(t => t._syncStatus !== 'deleted')
                                .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            teilnehmerSelect.innerHTML = '<option value="">-- Teilnehmer wählen --</option>';
            teilnehmer.forEach(t => {
                const option = document.createElement('option');
                option.value = t.localId;
                option.textContent = `${t.vorname || ''} ${t.name || ''}`.trim();
                teilnehmerSelect.appendChild(option);
            });
        }
        ladeTeilnehmer(); // Beim Laden aufrufen
        */

        anzahlForm.addEventListener("submit", (event) => {
          event.preventDefault();
          const anzahl = parseInt(anzahlInput.value);

          if (isNaN(anzahl) || anzahl < 1) {
            // NEU: zeigeStatus verwenden
            zeigeStatus('Bitte eine gültige Anzahl an Scheiben eingeben (mindestens 1).', 'fehler', statusMeldung);
            return;
          }

          tabelleBody.innerHTML = "";
          for (let i = 1; i <= anzahl; i++) {
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>${i}</td>
                        <td><input type="number" class="scheiben-wert-input" min="0" step="1" placeholder="Wert" required style="width: 60px; text-align: right; padding: 2px 4px;"></td>
                    `;
            tabelleBody.appendChild(row);
          }

          gesamtSummeTd.textContent = "0";
          durchschnittSummeTd.textContent = "-";
          erfassungsDiv.style.display = "block";

          tabelleBody
            .querySelectorAll(".scheiben-wert-input")
            .forEach((input) => {
              input.addEventListener("input", berechneUndZeigeSummen);
              input.addEventListener("change", berechneUndZeigeSummen);
            });

          berechneUndZeigeSummen();

          const firstInput = tabelleBody.querySelector(".scheiben-wert-input");
          if (firstInput) {
            firstInput.focus();
          }
        });

        function berechneUndZeigeSummen() {
          const inputs = tabelleBody.querySelectorAll(".scheiben-wert-input");
          let gesamt = 0;
          let anzahlGueltigerWerte = 0;

          inputs.forEach((input) => {
            const wert = parseInt(input.value);
            if (!isNaN(wert) && wert >= 0) {
              gesamt += wert;
              anzahlGueltigerWerte++;
              input.style.borderColor = ''; // Zurücksetzen, falls vorher rot
            } else if (input.value.trim() !== "") {
              input.style.borderColor = "red";
            } else {
              input.style.borderColor = "";
            }
          });

          gesamtSummeTd.textContent = gesamt;

          if (anzahlGueltigerWerte > 0) {
            const durchschnitt = gesamt / anzahlGueltigerWerte;
            durchschnittSummeTd.textContent = durchschnitt.toFixed(2);
          } else {
            durchschnittSummeTd.textContent = "-";
          }
        }

        // NEU: Event Listener für Speicher-Button
        speichernBtn.addEventListener('click', speichereScheibenWerte);

        // NEU: Funktion zum Speichern der Werte
        function speichereScheibenWerte() {
            const inputs = tabelleBody.querySelectorAll('.scheiben-wert-input');
            const werte = [];
            let alleGueltig = true;
            // TODO: const ausgewaehlterTeilnehmerId = teilnehmerSelect.value;

            /* TODO: Prüfen, ob Teilnehmer ausgewählt wurde
            if (!ausgewaehlterTeilnehmerId) {
                zeigeStatus('Bitte einen Teilnehmer auswählen.', 'fehler', statusMeldung);
                return;
            }
            */

            inputs.forEach(input => {
                const wert = parseInt(input.value);
                if (!isNaN(wert) && wert >= 0) {
                    werte.push(wert);
                    input.style.borderColor = '';
                } else {
                    input.style.borderColor = 'red';
                    alleGueltig = false;
                }
            });

            if (!alleGueltig) {
                zeigeStatus('Bitte alle Scheibenwerte korrekt eingeben.', 'fehler', statusMeldung);
                return;
            }

            if (werte.length === 0) {
                 zeigeStatus('Keine Werte zum Speichern vorhanden.', 'info', statusMeldung);
                 return;
            }

            const neuesScheibenErgebnis = {
                localId: generateLocalId(),
                firestoreId: null,
                // TODO: teilnehmerLocalId: ausgewaehlterTeilnehmerId, // Die ID des ausgewählten Teilnehmers
                werte: werte,
                gesamt: werte.reduce((sum, val) => sum + val, 0),
                durchschnitt: werte.length > 0 ? (werte.reduce((sum, val) => sum + val, 0) / werte.length) : 0,
                createdAt: new Date().toISOString(),
                _syncStatus: 'new'
            };

            try {
                // Stelle sicher, dass SCHEIBEN_KEY definiert ist (in local-storage-utils.js)
                if (typeof SCHEIBEN_KEY === 'undefined') {
                    throw new Error("SCHEIBEN_KEY ist nicht definiert. Bitte in local-storage-utils.js hinzufügen.");
                }
                const aktuelleScheiben = getLocalData(SCHEIBEN_KEY);
                aktuelleScheiben.push(neuesScheibenErgebnis);
                const success = setLocalData(SCHEIBEN_KEY, aktuelleScheiben);

                if (success) {
                    zeigeStatus(`Scheibenwerte (${werte.length} Stück) lokal gespeichert.`, 'erfolg', statusMeldung);
                    // Optional: Formular zurücksetzen
                    // anzahlInput.value = 1;
                    // erfassungsDiv.style.display = 'none';
                    // tabelleBody.innerHTML = '';
                    // gesamtSummeTd.textContent = '0';
                    // durchschnittSummeTd.textContent = '-';
                    // teilnehmerSelect.value = ''; // Auswahl zurücksetzen
                } else {
                    zeigeStatus('Fehler beim lokalen Speichern der Scheibenwerte!', 'fehler', statusMeldung);
                }
            } catch (error) {
                 console.error("Fehler beim Speichern der Scheiben:", error);
                 zeigeStatus(`Schwerwiegender Fehler beim Speichern: ${error.message}`, 'fehler', statusMeldung);
            }
        }

        // Optional: Listener für Storage-Events oder Sync-Events, um Teilnehmerliste neu zu laden
        /*
        window.addEventListener('storage', (event) => {
            if (event.key === TEILNEHMER_KEY) {
                ladeTeilnehmer();
            }
        });
        window.addEventListener('datasync-complete', () => {
             ladeTeilnehmer();
        });
        */

      });
    </script>
  </body>
</html>
