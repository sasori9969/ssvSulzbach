<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams anlegen (Offline-First)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Stile für Teams.html (angepasst für Offline-Status) */
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button[type="submit"] {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button[type="submit"]:hover {
            background-color: #45a049;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
            padding: 3px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            min-width: 60px; /* Minimale Breite */
            text-align: center;
        }

        .delete-btn:hover {
            background-color: #da190b;
        }

        #teamListe li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #teamListe li span {
            flex-grow: 1;
        }

        /* Stile für Sync-Status (wie in teilnehmer.html) */
        .sync-status {
            font-size: 0.8em;
            color: orange;
            margin-left: 10px;
            font-style: italic;
        }
        li.deleted {
            text-decoration: line-through;
            color: grey;
        }
        li.deleted .delete-btn {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>Schützenverein - Teams anlegen</h1>
    </header>
    <div class="container">
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="teilnehmer.html">Teilnehmer anlegen</a></li>
                <li><a href="teams.html" class="aktiv">Teams anlegen</a></li>
                <li><a href="zuordnung.html">Teamzuordnung</a></li>
                <li><a href="ergebnisErfassen.html">Ergebnisse erfassen</a></li>
                <li><a href="ergebnisseAusgeben.html">Ergebnisse ausgeben</a></li>
                <li><a href="statistik.html">Statistik</a></li>
            </ul>
        </nav>
        <main>
            <h2>Teams anlegen</h2>
            <form id="teamForm">
                <label for="teamname">Teamname:</label>
                <input type="text" id="teamname" required>
                <button type="submit" class="btn btn-primary">Hinzufügen</button>
            </form>

            <!-- Status und Confirm Modal (optional, aber empfohlen) -->
            <div id="statusMeldung" class="status-meldung" style="display: none;"></div>
            <div id="confirmModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <p id="confirmModalText">Möchtest du das wirklich tun?</p>
                    <button id="confirmModalOk" class="btn btn-danger">Ja</button>
                    <button id="confirmModalCancel" class="btn">Abbrechen</button>
                </div>
            </div>

            <h3>Gespeicherte Teams:</h3>
            <ul id="teamListe"></ul>
        </main>
    </div>

    <script type="module">
        // Firebase Imports (nur noch für Sync benötigt)
        import { db } from './firebase-config.js';
        import { collection, doc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // UI Utils Imports (falls du zeigeStatus/zeigeConfirm verwendest)
        import { zeigeStatus, zeigeConfirm } from './ui-utils.js'; // Pfad anpassen!

        // Local Storage Utils Imports
        import {
            getLocalData,
            setLocalData,
            generateLocalId,
            finalizeLocalItems,
            TEAMS_KEY // Importiere den Key für Teams
        } from './local-storage-utils.js'; // Pfad anpassen!

        const teamForm = document.getElementById("teamForm");
        const teamListe = document.getElementById("teamListe");

        // --- Lokale Teams anzeigen ---
        function displayTeamsFromLocal() {
            const lokaleTeams = getLocalData(TEAMS_KEY);

            // Sortieren (z.B. nach Teamname)
            lokaleTeams.sort((a, b) => (a.teamname || "").localeCompare(b.teamname || ""));

            teamListe.innerHTML = ""; // Liste leeren

            if (lokaleTeams.length === 0) {
                teamListe.innerHTML = "<li>Noch keine Teams lokal gespeichert.</li>";
                return;
            }

            lokaleTeams.forEach(team => {
                let li = document.createElement("li");
                const teamname = team.teamname || 'Unbenanntes Team';
                let syncStatusText = '';

                // Status für Anzeige bestimmen
                if (team._syncStatus === 'new') {
                    syncStatusText = '<span class="sync-status">(Neu, nicht synchronisiert)</span>';
                } else if (team._syncStatus === 'modified') {
                    // Hinweis: 'modified' wird hier noch nicht gesetzt, da wir nur hinzufügen/löschen
                    syncStatusText = '<span class="sync-status">(Geändert, nicht synchronisiert)</span>';
                } else if (team._syncStatus === 'deleted') {
                    syncStatusText = '<span class="sync-status">(Wird beim nächsten Sync gelöscht)</span>';
                    li.classList.add('deleted');
                }

                li.innerHTML = `
                    <span>${teamname}</span>
                    ${syncStatusText}
                    <button class="delete-btn" data-local-id="${team.localId}">Löschen</button>
                `;
                // Füge data-Attribute hinzu
                li.dataset.localId = team.localId;
                li.dataset.syncStatus = team._syncStatus;

                teamListe.appendChild(li);
            });
        }

        // --- Team hinzufügen (LOKAL) ---
        teamForm.addEventListener("submit", function (e) {
            e.preventDefault();
            let teamname = document.getElementById("teamname").value.trim();

            if (teamname === "") {
                zeigeStatus("Bitte einen Teamnamen eingeben!", 'fehler');
                return;
            }

            // Neues Team-Objekt für lokalen Speicher
            const neuesTeam = {
                localId: generateLocalId(), // Eigene lokale ID
                firestoreId: null,          // Firestore ID kommt erst nach Sync
                teamname: teamname,
                mitglieder: [],             // Initial leere Mitgliederliste (wird in zuordnung.html gefüllt)
                createdAt: new Date().toISOString(), // Lokaler Zeitstempel
                _syncStatus: 'new'          // Status für Sync
            };

            // Aktuelle Liste holen, neues Team hinzufügen, zurückspeichern
            const aktuelleTeams = getLocalData(TEAMS_KEY);
            aktuelleTeams.push(neuesTeam);
            const success = setLocalData(TEAMS_KEY, aktuelleTeams);

            if (success) {
                zeigeStatus("Team lokal hinzugefügt!", 'erfolg');
                teamForm.reset();
                displayTeamsFromLocal(); // Liste sofort aktualisieren
            } else {
                 zeigeStatus("Fehler beim lokalen Speichern des Teams!", 'fehler');
            }
        });

        // --- Team löschen (LOKAL markieren) ---
        teamListe.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                e.stopPropagation();
                const localId = deleteButton.getAttribute('data-local-id');
                const listItem = deleteButton.closest('li');
                const currentSyncStatus = listItem.dataset.syncStatus;

                if (currentSyncStatus === 'deleted') {
                    return; // Nicht erneut löschen
                }

                // Wichtiger Hinweis: Hier sollte geprüft werden, ob das Team noch Mitglieder hat
                // oder in Ergebnissen verwendet wird, bevor es gelöscht wird.
                // Das macht die Logik komplexer und erfordert Zugriff auf andere lokale Daten.
                // Fürs Erste implementieren wir das einfache Löschen.
                // Man könnte auch in der `zuordnung.html` verhindern, dass gelöschte Teams ausgewählt werden.

                zeigeConfirm(`Möchtest du das Team "${listItem.querySelector('span').textContent}" wirklich löschen?`, () => {
                    const aktuelleTeams = getLocalData(TEAMS_KEY);
                    const index = aktuelleTeams.findIndex(t => t.localId === localId);

                    if (index > -1) {
                        if (aktuelleTeams[index]._syncStatus === 'new') {
                            aktuelleTeams.splice(index, 1);
                            zeigeStatus("Team lokal entfernt (war noch nicht synchronisiert).", 'erfolg');
                        } else {
                            aktuelleTeams[index]._syncStatus = 'deleted';
                            // Wichtig: Auch die Mitgliederliste sollte hier ggf. geleert werden,
                            // oder die Zuordnungslogik muss gelöschte Teams ignorieren.
                            // aktuelleTeams[index].mitglieder = []; // Optional: Mitglieder entfernen
                            zeigeStatus("Team zum Löschen markiert (wird beim nächsten Sync entfernt).", 'erfolg');
                        }

                        const success = setLocalData(TEAMS_KEY, aktuelleTeams);
                        if (success) {
                            displayTeamsFromLocal(); // Liste neu anzeigen
                        } else {
                             zeigeStatus("Fehler beim lokalen Speichern der Löschmarkierung!", 'fehler');
                        }

                    } else {
                         zeigeStatus("Team nicht gefunden.", 'fehler');
                    }
                });
            }
        });

        // --- Periodische Synchronisation für Teams mit Firestore ---
        async function syncTeamsMitFirestore() {
            console.log("Prüfe auf lokale Änderungen für Synchronisation (Teams)...");

            const lokaleTeams = getLocalData(TEAMS_KEY);

            const hatAenderungen = lokaleTeams.some(item => item._syncStatus && item._syncStatus !== 'synced');

            if (!hatAenderungen) {
                console.log("Keine lokalen Team-Änderungen zum Synchronisieren.");
                return;
            }

            console.log("Änderungen bei Teams gefunden. Starte Sync mit Firestore...");
            zeigeStatus("Synchronisiere Teams mit Server...", "info");

            const batch = writeBatch(db);
            let changesInBatch = false;
            let zuAktualisierendeLokaleTeams = structuredClone(lokaleTeams);

            try {
                zuAktualisierendeLokaleTeams.forEach((team, index) => {
                    if (!team._syncStatus || team._syncStatus === 'synced') {
                        return;
                    }

                    if (team._syncStatus === 'new') {
                        const docRef = doc(collection(db, "teams"));
                        batch.set(docRef, {
                            teamname: team.teamname,
                            mitglieder: team.mitglieder || [], // Sicherstellen, dass es ein Array ist
                            timestamp: serverTimestamp()
                        });
                        zuAktualisierendeLokaleTeams[index].firestoreId = docRef.id;
                        zuAktualisierendeLokaleTeams[index]._pendingSync = true;
                        changesInBatch = true;
                        console.log(`Sync: Neues Team "${team.teamname}" wird hinzugefügt.`);

                    } else if (team._syncStatus === 'modified' && team.firestoreId) {
                        // Diese Logik wird relevant, wenn wir Teams bearbeiten (z.B. in zuordnung.html)
                        const docRef = doc(db, "teams", team.firestoreId);
                        batch.update(docRef, {
                            teamname: team.teamname, // Falls Name änderbar wäre
                            mitglieder: team.mitglieder || [] // Wichtig für Zuordnungs-Updates
                        });
                        zuAktualisierendeLokaleTeams[index]._pendingSync = true;
                        changesInBatch = true;
                        console.log(`Sync: Team "${team.teamname}" (${team.firestoreId}) wird aktualisiert.`);

                    } else if (team._syncStatus === 'deleted' && team.firestoreId) {
                        const docRef = doc(db, "teams", team.firestoreId);
                        batch.delete(docRef);
                        zuAktualisierendeLokaleTeams[index]._toBeRemoved = true;
                        changesInBatch = true;
                        console.log(`Sync: Team "${team.teamname}" (${team.firestoreId}) wird gelöscht.`);

                    } else if (team._syncStatus === 'deleted' && !team.firestoreId) {
                        console.warn(`Sync: Team "${team.teamname}" war zum Löschen markiert, hatte aber keine Firestore ID. Wird lokal entfernt.`);
                        zuAktualisierendeLokaleTeams[index]._toBeRemoved = true;

                    } else if (team._syncStatus === 'modified' && !team.firestoreId) {
                        console.error(`Sync: Inkonsistenter Status für "${team.teamname}". Status 'modified' aber keine Firestore ID.`);
                    }
                });

                if (changesInBatch) {
                    await batch.commit();
                    console.log("Firestore Batch-Commit für Teams erfolgreich.");

                    const finaleLokaleTeams = finalizeLocalItems(zuAktualisierendeLokaleTeams);
                    const success = setLocalData(TEAMS_KEY, finaleLokaleTeams);

                    if (success) {
                        displayTeamsFromLocal();
                        zeigeStatus("Teams erfolgreich synchronisiert!", 'erfolg');
                    } else {
                        zeigeStatus("Fehler beim Speichern der finalen lokalen Teamdaten nach Sync!", 'fehler');
                    }

                } else {
                    // Nur lokale Bereinigung durchführen, falls nötig
                    const finaleLokaleTeams = finalizeLocalItems(zuAktualisierendeLokaleTeams);
                     if (finaleLokaleTeams.length !== lokaleTeams.length) {
                         const success = setLocalData(TEAMS_KEY, finaleLokaleTeams);
                         if (success) {
                             displayTeamsFromLocal();
                             zeigeStatus("Lokale Team-Bereinigung abgeschlossen.", 'info');
                         } else {
                              zeigeStatus("Fehler beim Speichern der bereinigten lokalen Teamdaten!", 'fehler');
                         }
                     } else {
                         console.log("Keine Firestore-Operationen für Teams und keine lokale Bereinigung nötig.");
                     }
                }

            } catch (error) {
                console.error("Fehler während der Team-Synchronisation oder beim Batch-Commit:", error);
                zeigeStatus("Synchronisation der Teams fehlgeschlagen. Änderungen bleiben lokal.", 'fehler');
            }
        }

        // --- Initialisierung und Intervall ---
        document.addEventListener('DOMContentLoaded', () => {
            displayTeamsFromLocal(); // Beim Laden aus LocalStorage anzeigen

            // Sync alle 1 Stunde starten (oder kürzer zum Testen)
            const syncInterval = 60000; // 60 Sekunden zum Testen
            // const syncInterval = 1000 * 60 * 60; // 1 Stunde für Produktion

            // WICHTIG: Rufe hier die Sync-Funktion für Teams auf.
            // Wenn du eine zentrale Sync-Funktion hast, rufe diese auf.
            // Ansonsten rufe die spezifische Funktion für Teams auf.
      //      setInterval(syncTeamsMitFirestore, syncInterval);

            // Optional: Sofort einmal synchronisieren beim Start
        //    setTimeout(syncTeamsMitFirestore, 5500); // Leicht versetzt zu Teilnehmern, falls getrennt
        });

    </script>

</body>
</html>
