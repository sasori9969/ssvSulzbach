<!-- /workspaces/ssvSulzbach/adminOnly.html -->
<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Bereich (Offline-First)</title>
    <link rel="stylesheet" href="style.css" />
    <script src="load-nav.js" defer></script>
    <script type="module" src="auto-sync.js" defer></script>

    <style>
      /* ... (bestehende Stile) ... */
      #lastSyncInfo {
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
      }
      #manualSyncBtn {
        margin-right: 10px;
      }
      /* NEU: Abstand für den neuen Button */
      #deleteAllBtn {
          margin-top: 20px; /* Abstand nach oben */
      }
      .lade-anzeige {
        display: none;
        margin-left: 10px;
        font-style: italic;
      }
      .lade-kreis {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db; /* Standard Blau */
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 5px;
      }
      /* NEU: Roter Kreis für Lösch-Spinner */
      .lade-kreis.danger {
          border-top-color: #dc3545; /* Rot */
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      /* Statusmeldungen (wie in ui-utils.js definiert) */
      .status-meldung {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 4px;
        display: none;
      }
      .status-meldung.erfolg { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
      .status-meldung.fehler { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
      .status-meldung.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
  </head>
  <body>
    <header>
      <h1>Schützenverein - Admin Bereich</h1>
    </header>
    <div class="container">
      <div id="navigation-placeholder"></div>
      <main>
        <h2>Admin Aktionen</h2>
        <div id="statusMeldung" class="status-meldung"></div>

        <div id="lastSyncInfo">
          Letzte erfolgreiche Synchronisation:
          <span id="lastSyncTime">Wird geladen...</span>
        </div>

        <button id="manualSyncBtn" class="btn btn-primary">
          Manuelle Synchronisation starten
        </button>
        <span id="syncSpinner" class="lade-anzeige">
          <span class="lade-kreis"></span> Synchronisiere...
        </span>

        <hr style="margin: 30px 0;"> <!-- Trennlinie -->

        <h3>Gefahrenzone</h3>
        <button id="deleteAllBtn" class="btn btn-danger">
          Alle Wettkampfdaten löschen (Neuer Wettbewerb)
        </button>
        <span id="deleteSpinner" class="lade-anzeige">
          <span class="lade-kreis danger"></span> Lösche Daten...
        </span>

      </main>
    </div>

    <script type="module">
      // UI Utils Imports
      import { zeigeStatus, zeigeConfirm } from "./ui-utils.js"; // zeigeConfirm hinzugefügt

      // Local Storage Utils Imports
      import {
        getLocalData,
        setLocalData,
        LAST_SYNC_KEY,
        clearLocalStorageData // NEU: Importieren
      } from "./local-storage-utils.js";

      // Importiere die zentrale Sync-Funktion und die neue Löschfunktion
      import { synchronizeAllData, deleteAllFirebaseData } from "./sync-manager.js"; // NEU: deleteAllFirebaseData importieren

      const lastSyncTimeSpan = document.getElementById("lastSyncTime");
      const manualSyncBtn = document.getElementById("manualSyncBtn");
      const syncSpinner = document.getElementById("syncSpinner");
      const statusMeldung = document.getElementById("statusMeldung");
      const deleteAllBtn = document.getElementById("deleteAllBtn"); // NEU
      const deleteSpinner = document.getElementById("deleteSpinner"); // NEU

      // --- Bestehende Funktionen (displayLastSyncTime) bleiben unverändert ---
      function displayLastSyncTime(timestampString) {
        if (timestampString) {
          try {
            const date = new Date(timestampString);
            lastSyncTimeSpan.textContent = date.toLocaleString("de-DE");
          } catch (e) {
            lastSyncTimeSpan.textContent = "Ungültiges Datum";
            console.error("Ungültiges Datum im localStorage für LAST_SYNC_KEY:", timestampString);
          }
        } else {
          lastSyncTimeSpan.textContent = "Noch nie synchronisiert";
        }
      }

      // --- Event Listener für manuellen Sync (bleibt unverändert) ---
      manualSyncBtn.addEventListener("click", async () => {
        manualSyncBtn.disabled = true;
        deleteAllBtn.disabled = true; // Auch anderen Button sperren
        syncSpinner.style.display = "inline-block";
        try {
          await synchronizeAllData(true, statusMeldung);
          const lastSyncTimestamp = getLocalData(LAST_SYNC_KEY);
          displayLastSyncTime(lastSyncTimestamp);
        } catch (error) {
          console.error("Unerwarteter Fehler beim Aufruf der manuellen Synchronisation:", error);
          zeigeStatus("Ein unerwarteter Fehler ist aufgetreten.", "fehler", statusMeldung);
        } finally {
          syncSpinner.style.display = "none";
          manualSyncBtn.disabled = false;
          deleteAllBtn.disabled = false; // Wieder freigeben
        }
      });

      // --- NEU: Event Listener für "Alles Löschen" Button ---
      deleteAllBtn.addEventListener("click", () => {
        zeigeConfirm(
          "ACHTUNG! Bist du sicher, dass du ALLE Teilnehmer, Teams, Ergebnisse und Zahlungsdaten unwiderruflich löschen möchtest? Dies ist für den Start eines NEUEN Wettbewerbs gedacht.",
          () => { // onConfirm Callback
            const code = prompt("Bitte gib den Bestätigungscode ein, um fortzufahren:");
            if (code === "0009") {
              // Code ist korrekt, starte den Löschvorgang
              performDeleteAllData();
            } else if (code !== null) { // Nur wenn nicht auf "Abbrechen" geklickt wurde
              zeigeStatus("Falscher Bestätigungscode. Löschvorgang abgebrochen.", "fehler", statusMeldung);
            }
          }
        );
      });

      // --- NEU: Funktion zum Ausführen des Löschvorgangs ---
      async function performDeleteAllData() {
        deleteAllBtn.disabled = true;
        manualSyncBtn.disabled = true; // Auch anderen Button sperren
        deleteSpinner.style.display = "inline-block";
        zeigeStatus("Lösche alle Daten...", "info", statusMeldung);

        let localSuccess = false;
        let firebaseSuccess = false;

        try {
          // 1. Lokale Daten löschen
          zeigeStatus("Lösche lokale Daten...", "info", statusMeldung);
          localSuccess = clearLocalStorageData();
          if (!localSuccess) {
            throw new Error("Fehler beim Löschen der lokalen Daten.");
          }
          zeigeStatus("Lokale Daten gelöscht. Lösche Firebase Daten...", "info", statusMeldung);

          // 2. Firebase Daten löschen
          firebaseSuccess = await deleteAllFirebaseData(); // Diese Funktion muss in sync-manager.js erstellt werden
          if (!firebaseSuccess) {
             throw new Error("Fehler beim Löschen der Firebase Daten.");
          }

          // 3. Erfolg melden und UI aktualisieren
          zeigeStatus("Alle Wettkampfdaten erfolgreich gelöscht!", "erfolg", statusMeldung);
          // Letzten Sync-Zeitstempel auch löschen/zurücksetzen
          displayLastSyncTime(null);
          // Optional: Seite neu laden nach Erfolg?
          // setTimeout(() => window.location.reload(), 2000);

        } catch (error) {
          console.error("Fehler beim Löschen aller Daten:", error);
          let errMsg = `Fehler beim Löschen: ${error.message}`;
          if (localSuccess && !firebaseSuccess) {
              errMsg = "Lokale Daten gelöscht, aber Fehler beim Löschen der Firebase Daten! Bitte manuell prüfen.";
          } else if (!localSuccess) {
              errMsg = "Fehler beim Löschen der lokalen Daten! Firebase wurde nicht angerührt.";
          }
          zeigeStatus(errMsg, "fehler", statusMeldung);
        } finally {
          // Spinner ausblenden und Buttons wieder aktivieren
          deleteSpinner.style.display = "none";
          deleteAllBtn.disabled = false;
          manualSyncBtn.disabled = false;
        }
      }


      // --- Initialisierung (bleibt fast unverändert) ---
      document.addEventListener("DOMContentLoaded", () => {
        const lastSyncTimestamp = getLocalData(LAST_SYNC_KEY);
        displayLastSyncTime(lastSyncTimestamp);

        // Optionaler initialer Sync-Check bleibt bestehen
        setTimeout(async () => {
          if (!manualSyncBtn.disabled) { // Nur wenn nicht gerade ein anderer Prozess läuft
            console.log("Initialer Sync-Check nach Laden der Admin-Seite...");
            manualSyncBtn.disabled = true; // Sperren währenddessen
            deleteAllBtn.disabled = true;
            syncSpinner.style.display = 'inline-block'; // Zeige Spinner
            try {
                await synchronizeAllData(true, statusMeldung);
                const lastSyncTimestamp = getLocalData(LAST_SYNC_KEY);
                displayLastSyncTime(lastSyncTimestamp);
            } catch(e) { /* Fehler wird von synchronizeAllData behandelt */ }
            finally {
                syncSpinner.style.display = 'none';
                manualSyncBtn.disabled = false;
                deleteAllBtn.disabled = false;
            }
          }
        }, 5000);
      });
    </script>
  </body>
</html>
