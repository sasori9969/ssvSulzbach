<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Bereich (Offline-First)</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ... (bestehende Stile bleiben unverändert) ... */
         #lastSyncInfo {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        #manualSyncBtn {
            margin-right: 10px;
        }
        .lade-anzeige { /* Style für Ladeanzeige */
            display: none; /* Standardmäßig ausblenden */
            margin-left: 10px;
            font-style: italic;
        }
        .lade-kreis {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block; /* Damit es neben Text steht */
            vertical-align: middle;
            margin-right: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
         /* Statusmeldungen (wie in ui-utils.js definiert) */
        .status-meldung {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none; /* Standardmäßig ausblenden */
        }
        .status-meldung.erfolg { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-meldung.fehler { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-meldung.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <header>
        <h1>Schützenverein - Admin Bereich</h1>
    </header>
    <div class="container">
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="teilnehmer.html">Teilnehmer anlegen</a></li>
                <li><a href="teams.html">Teams anlegen</a></li>
                <li><a href="zuordnung.html">Teamzuordnung</a></li>
                <li><a href="ergebnisErfassen.html">Ergebnisse erfassen</a></li>
                <li><a href="ergebnisseAusgeben.html">Ergebnisse ausgeben</a></li>
                <li><a href="statistik.html">Statistik</a></li>
                <li><a href="adminOnly.html" class="aktiv">Admin</a></li>
            </ul>
        </nav>
        <main>
            <h2>Admin Aktionen</h2>
            <div id="statusMeldung" class="status-meldung" style="display: none;"></div>

            <div id="lastSyncInfo">
                Letzte erfolgreiche Synchronisation: <span id="lastSyncTime">Wird geladen...</span>
            </div>

            <button id="manualSyncBtn" class="btn btn-warning">Manuelle Synchronisation starten</button>
            <span id="syncSpinner" class="lade-anzeige">
                <span class="lade-kreis"></span> Synchronisiere...
            </span>

        </main>
    </div>

    <script type="module">
        // UI Utils Imports
        import { zeigeStatus } from './ui-utils.js';

        // Local Storage Utils Imports
        import { getLocalData, setLocalData, LAST_SYNC_KEY } from './local-storage-utils.js';

        // *** NEU: Importiere die ECHTE zentrale Sync-Funktion ***
        import { synchronizeAllData } from './sync-manager.js';

        const lastSyncTimeSpan = document.getElementById('lastSyncTime');
        const manualSyncBtn = document.getElementById('manualSyncBtn');
        const syncSpinner = document.getElementById('syncSpinner');
        const statusMeldung = document.getElementById('statusMeldung'); // Wird jetzt von sync-manager genutzt

        // Zeigt den letzten Sync-Zeitstempel an (unverändert)
        function displayLastSyncTime(timestampString) {
            if (timestampString) {
                try {
                    const date = new Date(timestampString);
                    lastSyncTimeSpan.textContent = date.toLocaleString('de-DE');
                } catch (e) {
                    lastSyncTimeSpan.textContent = "Ungültiges Datum";
                    console.error("Ungültiges Datum im localStorage für LAST_SYNC_KEY:", timestampString);
                }
            } else {
                lastSyncTimeSpan.textContent = "Noch nie synchronisiert";
            }
        }

        // Event Listener für den manuellen Sync Button (angepasst)
        manualSyncBtn.addEventListener('click', async () => {
            manualSyncBtn.disabled = true;
            syncSpinner.style.display = 'inline-block';
            // Statusmeldung wird jetzt in synchronizeAllData gesetzt

            try {
                // *** Rufe die ECHTE zentrale Sync-Funktion auf ***
                const syncSuccess = await synchronizeAllData(true); // true = zeige Statusmeldungen

                // Nach erfolgreichem Sync (egal ob was geändert wurde oder nicht), Zeitstempel neu laden
                if (syncSuccess) {
                     const lastSyncTimestamp = getLocalData(LAST_SYNC_KEY);
                     displayLastSyncTime(lastSyncTimestamp); // UI direkt aktualisieren
                }
                // Fehlermeldungen werden von synchronizeAllData angezeigt

            } catch (error) {
                // Fängt Fehler ab, die synchronizeAllData selbst wirft (sollte nicht passieren, da dort try/catch ist)
                console.error("Unerwarteter Fehler beim Aufruf der manuellen Synchronisation:", error);
                zeigeStatus("Ein unerwarteter Fehler ist aufgetreten.", 'fehler', statusMeldung);
            } finally {
                // Spinner ausblenden und Button wieder aktivieren, egal ob Erfolg oder Fehler
                syncSpinner.style.display = 'none';
                manualSyncBtn.disabled = false;
            }
        });

        // Initialisierung beim Laden der Seite (unverändert)
        document.addEventListener('DOMContentLoaded', () => {
            const lastSyncTimestamp = getLocalData(LAST_SYNC_KEY);
            displayLastSyncTime(lastSyncTimestamp);

            // --- Periodische Synchronisation ---
            // Hier entscheiden, wie oft automatisch synchronisiert werden soll.
            // Beispiel: Alle 15 Minuten (900000 ms)
            const AUTO_SYNC_INTERVAL = 15 * 60 * 1000; // 15 Minuten
            // const AUTO_SYNC_INTERVAL = 60 * 1000; // 1 Minute zum Testen

            // Starte den Timer für die automatische Synchronisation
            setInterval(async () => {
                 console.log("Automatischer Sync-Check gestartet...");
                 // Führe den Sync "im Hintergrund" aus (ohne UI-Statusmeldungen auf dieser Seite)
                 await synchronizeAllData(false);
                 // Zeitstempel im Admin-Panel aktualisieren, falls es offen ist
                 const lastSyncTimestamp = getLocalData(LAST_SYNC_KEY);
                 displayLastSyncTime(lastSyncTimestamp);
            }, AUTO_SYNC_INTERVAL);

             // Optional: Einmaliger Sync kurz nach dem Laden der Admin-Seite
             setTimeout(async () => {
                 console.log("Initialer Sync-Check nach Laden der Admin-Seite...");
                 await synchronizeAllData(true); // Mit Statusmeldung beim ersten Mal
                 const lastSyncTimestamp = getLocalData(LAST_SYNC_KEY);
                 displayLastSyncTime(lastSyncTimestamp);
             }, 5000); // 5 Sekunden nach Laden
        });

    </script>
</body>
</html>
