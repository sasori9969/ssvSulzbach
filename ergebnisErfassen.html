<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ergebnisse erfassen (Offline-First)</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Zentrales Auto-Sync Skript einbinden -->
    <script type="module" src="auto-sync.js" defer></script>
    <!-- NEU: Skript zum Laden der Navigation einbinden -->
    <script src="load-nav.js" defer></script>
    <style>
      /* Zusätzliches Styling für die Tabelle */
      #ergebnisTabelle {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1em;
      }
      #ergebnisTabelle th,
      #ergebnisTabelle td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      #ergebnisTabelle th {
        background-color: #f2f2f2;
      }
      #ergebnisTabelle .actions-cell button {
        margin-right: 5px;
        padding: 3px 6px; /* Kleinere Buttons */
        font-size: 0.9em;
      }
      #ergebnisTabelle .deleted td {
         text-decoration: line-through;
         color: grey;
      }
      #ergebnisTabelle .sync-status {
        font-size: 0.8em;
        color: #666;
        display: block; /* Eigene Zeile für Status */
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Schützenverein - Ergebnisse erfassen</h1>
    </header>
    <div class="container">
      <!-- Navigation Platzhalter -->
      <div id="navigation-placeholder"></div>
      <main>
        <h2>Neues Ergebnis erfassen / Bearbeiten</h2>
        <form id="ergebnisForm">
          <input type="hidden" id="editLocalId" />

          <label for="teilnehmerSelect">Teilnehmer:</label>
          <select id="teilnehmerSelect" required>
            <option value="">-- Bitte wählen --</option>
          </select>

          <label for="teamSelect">Team (optional):</label>
          <select id="teamSelect">
            <option value="">-- Kein Team --</option>
          </select>

          <label for="ringzahl">Ringzahl:</label>
          <input type="number" id="ringzahl" required min="0" />

          <!-- Teiler Feld entfernt -->
          <!-- <label for="teiler">Teiler (optional):</label>
          <input type="number" id="teiler" step="0.1" min="0" /> -->

          <label for="bemerkung">Bemerkung (optional):</label>
          <input type="text" id="bemerkung" />

          <button type="submit" class="btn btn-primary">Speichern</button>
          <button type="button" id="cancelEditBtn" class="btn" style="display: none">
            Abbrechen
          </button>
        </form>

        <div id="statusMeldung" class="status-meldung"></div>

        <div id="confirmModal" class="modal">
          <div class="modal-content">
            <p id="confirmModalText">Möchtest du das wirklich tun?</p>
            <button id="confirmModalOk" class="btn btn-danger">Ja</button>
            <button id="confirmModalCancel" class="btn">Abbrechen</button>
          </div>
        </div>

        <h3>Gespeicherte Ergebnisse:</h3>
        <!-- Ersetzt <ul> durch <table> -->
        <table id="ergebnisTabelle">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Teilnehmer</th>
                    <th>Team</th>
                    <th>Ringe</th>
                    <th>Bemerkung</th>
                    <th>Status</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody id="ergebnisListe">
                <!-- Ergebnisse werden hier dynamisch eingefügt -->
            </tbody>
        </table>
      </main>
    </div>

    <script type="module">
      // UI Utils Imports
      import { zeigeStatus, zeigeConfirm } from "./ui-utils.js";

      // Local Storage Utils Imports
      import {
        getLocalData,
        setLocalData,
        generateLocalId,
        ERGEBNISSE_KEY,
        getActiveTeilnehmer,
        getActiveTeams,
        getActiveErgebnisse,
        createTeilnehmerMap,
        createTeamMap,
      } from "./local-storage-utils.js";

      const ergebnisForm = document.getElementById("ergebnisForm");
      const teilnehmerSelect = document.getElementById("teilnehmerSelect");
      const teamSelect = document.getElementById("teamSelect");
      const ringzahlInput = document.getElementById("ringzahl");
      // const teilerInput = document.getElementById("teiler"); // Entfernt
      const bemerkungInput = document.getElementById("bemerkung");
      const ergebnisListe = document.getElementById("ergebnisListe"); // Jetzt tbody
      const editLocalIdInput = document.getElementById("editLocalId");
      const cancelEditBtn = document.getElementById("cancelEditBtn");

      // Globale Variablen für Daten und Maps
      let teilnehmerMap = new Map();
      let teamMap = new Map();

      // Laden der initialen Daten (Teilnehmer, Teams) - unverändert
      function loadInitialData() {
        const teilnehmer = getActiveTeilnehmer();
        const teams = getActiveTeams();

        teilnehmerSelect.innerHTML = '<option value="">-- Bitte wählen --</option>';
        teilnehmer.forEach((t) => {
          const option = document.createElement("option");
          option.value = t.localId;
          option.textContent = `${t.vorname || ""} ${t.name || ""}`.trim();
          teilnehmerSelect.appendChild(option);
        });

        teamSelect.innerHTML = '<option value="">-- Kein Team --</option>';
        teams.forEach((t) => {
          const option = document.createElement("option");
          option.value = t.localId;
          option.textContent = t.teamname || "Unbenanntes Team";
          teamSelect.appendChild(option);
        });

        teilnehmerMap = createTeilnehmerMap(teilnehmer);
        teamMap = createTeamMap(teams);
      }

      // Ergebnisse anzeigen - **ANGEPASST FÜR TABELLE**
      function displayErgebnisseFromLocal() {
        const lokaleErgebnisse = getActiveErgebnisse(); // Holt aktive und sortierte Ergebnisse
        ergebnisListe.innerHTML = ""; // tbody leeren

        if (lokaleErgebnisse.length === 0) {
          const row = ergebnisListe.insertRow();
          const cell = row.insertCell();
          cell.colSpan = 7; // Anzahl der Spalten
          cell.textContent = "Noch keine Ergebnisse lokal gespeichert.";
          return;
        }

        lokaleErgebnisse.forEach((ergebnis) => {
          const row = ergebnisListe.insertRow();
          row.dataset.localId = ergebnis.localId; // ID an die Zeile hängen
          row.dataset.syncStatus = ergebnis._syncStatus;

          const teilnehmer = teilnehmerMap.get(ergebnis.teilnehmerLocalId);
          const team = ergebnis.teamLocalId ? teamMap.get(ergebnis.teamLocalId) : null;

          const teilnehmerName = teilnehmer
            ? `${teilnehmer.vorname || ""} ${teilnehmer.name || ""}`.trim()
            : "Unbekannt";
          const teamName = team ? (team.teamname || "Unbekannt") : "-";
          const ringe = ergebnis.ringzahl ?? "N/A";
          // const teiler = ergebnis.teiler ? `${ergebnis.teiler}` : "-"; // Entfernt
          const bemerkung = ergebnis.bemerkung || "-";
          const datum = ergebnis.createdAt
            ? new Date(ergebnis.createdAt).toLocaleString("de-DE", { dateStyle: 'short', timeStyle: 'short'})
            : "-";

          let syncStatusText = "";
          let statusKurz = "";
          if (ergebnis._syncStatus === "new") {
            syncStatusText = "Neu, nicht synchronisiert";
            statusKurz = "Neu";
          } else if (ergebnis._syncStatus === "modified") {
            syncStatusText = "Geändert, nicht synchronisiert";
            statusKurz = "Geändert";
          } else if (ergebnis._syncStatus === "deleted") {
            // Sollte nicht mehr vorkommen, aber zur Sicherheit
            syncStatusText = "Wird beim nächsten Sync gelöscht";
            statusKurz = "Gelöscht";
            row.classList.add("deleted");
          } else {
             syncStatusText = "Synchronisiert";
             statusKurz = "Synced";
          }

          // Zellen erstellen und füllen
          row.insertCell().textContent = datum;
          row.insertCell().textContent = teilnehmerName;
          row.insertCell().textContent = teamName;
          row.insertCell().textContent = ringe;
          row.insertCell().textContent = bemerkung;

          // Status Zelle
          const statusCell = row.insertCell();
          statusCell.innerHTML = `<span class="sync-status" title="${syncStatusText}">${statusKurz}</span>`;

          // Aktionen Zelle
          const actionsCell = row.insertCell();
          actionsCell.classList.add('actions-cell'); // Klasse für Styling
          actionsCell.innerHTML = `
            <button class="edit-btn btn btn-secondary" data-local-id="${ergebnis.localId}">Edit</button>
            <button class="delete-btn btn btn-danger" data-local-id="${ergebnis.localId}">X</button>
          `;
        });
      }

      // Ergebnis speichern oder aktualisieren - **ANGEPASST (ohne Teiler)**
      function saveOrUpdateErgebnisLokal(e) {
        e.preventDefault();
        const editLocalId = editLocalIdInput.value;

        const teilnehmerLocalId = teilnehmerSelect.value;
        const teamLocalId = teamSelect.value || null;
        const ringzahl = parseInt(ringzahlInput.value, 10);
        // const teiler = teilerInput.value ? parseFloat(teilerInput.value) : null; // Entfernt
        const bemerkung = bemerkungInput.value.trim();

        if (!teilnehmerLocalId || isNaN(ringzahl)) {
          zeigeStatus("Bitte Teilnehmer auswählen und Ringzahl angeben.", "fehler");
          return;
        }

        const alleErgebnisse = getLocalData(ERGEBNISSE_KEY);
        let status = "erfolg";
        let message = "";

        if (editLocalId) {
          // Bearbeiten
          const index = alleErgebnisse.findIndex((e) => e.localId === editLocalId);
          if (index > -1) {
            const existingErgebnis = alleErgebnisse[index];
            if (
              existingErgebnis.teilnehmerLocalId !== teilnehmerLocalId ||
              existingErgebnis.teamLocalId !== teamLocalId ||
              existingErgebnis.ringzahl !== ringzahl ||
              // existingErgebnis.teiler !== teiler || // Entfernt
              existingErgebnis.bemerkung !== bemerkung
            ) {
              existingErgebnis.teilnehmerLocalId = teilnehmerLocalId;
              existingErgebnis.teamLocalId = teamLocalId;
              existingErgebnis.ringzahl = ringzahl;
              // existingErgebnis.teiler = teiler; // Entfernt
              existingErgebnis.bemerkung = bemerkung;
              existingErgebnis.lastModifiedLocal = new Date().toISOString();
              if (existingErgebnis._syncStatus !== "new") {
                existingErgebnis._syncStatus = "modified";
              }
              message = "Ergebnis lokal aktualisiert.";
            } else {
              message = "Keine Änderungen am Ergebnis vorgenommen.";
              status = "info";
            }
          } else {
            message = "Fehler: Zu bearbeitendes Ergebnis nicht gefunden!";
            status = "fehler";
          }
        } else {
          // Neu hinzufügen
          const neuesErgebnis = {
            localId: generateLocalId(),
            firestoreId: null,
            teilnehmerLocalId: teilnehmerLocalId,
            teamLocalId: teamLocalId,
            ringzahl: ringzahl,
            // teiler: teiler, // Entfernt
            bemerkung: bemerkung,
            createdAt: new Date().toISOString(),
            _syncStatus: "new",
          };
          alleErgebnisse.push(neuesErgebnis);
          message = "Ergebnis lokal hinzugefügt.";
        }

        if (status !== "fehler") {
          const success = setLocalData(ERGEBNISSE_KEY, alleErgebnisse);
          if (!success) {
            message = "Fehler beim lokalen Speichern des Ergebnisses!";
            status = "fehler";
          }
        }

        zeigeStatus(message, status);

        if (status !== "fehler") {
          resetForm();
          displayErgebnisseFromLocal();
        }
      }

      // Formular zurücksetzen - unverändert
      function resetForm() {
        ergebnisForm.reset();
        editLocalIdInput.value = "";
        cancelEditBtn.style.display = "none";
        teilnehmerSelect.disabled = false;
        teamSelect.disabled = false;
      }

      // Ergebnis zum Bearbeiten laden - **ANGEPASST (ohne Teiler)**
      function loadErgebnisForEdit(localId) {
        const alleErgebnisse = getLocalData(ERGEBNISSE_KEY);
        const ergebnis = alleErgebnisse.find((e) => e.localId === localId);

        if (ergebnis) {
          editLocalIdInput.value = ergebnis.localId;
          teilnehmerSelect.value = ergebnis.teilnehmerLocalId;
          teamSelect.value = ergebnis.teamLocalId || "";
          ringzahlInput.value = ergebnis.ringzahl ?? "";
          // teilerInput.value = ergebnis.teiler ?? ""; // Entfernt
          bemerkungInput.value = ergebnis.bemerkung || "";

          cancelEditBtn.style.display = "inline-block";
          window.scrollTo(0, 0);
        } else {
          zeigeStatus("Zu bearbeitendes Ergebnis nicht gefunden.", "fehler");
        }
      }

      // Ergebnis löschen (LOKAL markieren) - unverändert
      function deleteErgebnisLokal(localId) {
        zeigeConfirm("Möchtest du dieses Ergebnis wirklich löschen?", () => {
          const alleErgebnisse = getLocalData(ERGEBNISSE_KEY);
          const index = alleErgebnisse.findIndex((e) => e.localId === localId);

          if (index > -1) {
            let message = "";
            let status = "erfolg";
            if (alleErgebnisse[index]._syncStatus === "new") {
              alleErgebnisse.splice(index, 1);
              message = "Ergebnis lokal entfernt (war noch nicht synchronisiert).";
            } else {
              alleErgebnisse[index]._syncStatus = "deleted";
              message = "Ergebnis zum Löschen markiert (wird beim nächsten Sync entfernt).";
            }
            const success = setLocalData(ERGEBNISSE_KEY, alleErgebnisse);
            if (success) {
              displayErgebnisseFromLocal();
            } else {
              message = "Fehler beim lokalen Speichern der Löschmarkierung!";
              status = "fehler";
            }
            zeigeStatus(message, status);
          } else {
            zeigeStatus("Zu löschendes Ergebnis nicht gefunden.", "fehler");
          }
        });
      }

      // Event Listener - unverändert (nutzt Event Delegation für Tabelle)
      ergebnisForm.addEventListener("submit", saveOrUpdateErgebnisLokal);
      cancelEditBtn.addEventListener("click", resetForm);

      ergebnisListe.addEventListener("click", (e) => { // Listener am tbody
        const editButton = e.target.closest(".edit-btn");
        const deleteButton = e.target.closest(".delete-btn");

        if (editButton) {
          e.stopPropagation();
          const localId = editButton.getAttribute("data-local-id");
          loadErgebnisForEdit(localId);
        } else if (deleteButton) {
          e.stopPropagation();
          const localId = deleteButton.getAttribute("data-local-id");
          deleteErgebnisLokal(localId);
        }
      });

      // Initialisierung - unverändert
      document.addEventListener("DOMContentLoaded", () => {
        loadInitialData();
        displayErgebnisseFromLocal();

        window.addEventListener('datasync-complete', (event) => {
            if (event.detail?.success) {
                console.log("Daten neu laden nach erfolgreichem Sync...");
                loadInitialData();
                displayErgebnisseFromLocal();
            }
        });
      });
    </script>
  </body>
</html>
