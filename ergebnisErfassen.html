<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ergebnisse erfassen (Offline-First)</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Zentrales Auto-Sync Skript einbinden -->
    <script type="module" src="auto-sync.js" defer></script>
    <!-- NEU: Skript zum Laden der Navigation einbinden -->
    <script src="load-nav.js" defer></script>
    <style>
      /* Zusätzliches Styling für die Tabelle */
      #ergebnisTabelle {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1em;
      }
      #ergebnisTabelle th,
      #ergebnisTabelle td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      #ergebnisTabelle th {
        background-color: #f2f2f2;
      }
      #ergebnisTabelle .actions-cell button {
        margin-right: 5px;
        padding: 3px 6px; /* Kleinere Buttons */
        font-size: 0.9em;
      }
      #ergebnisTabelle .deleted td {
         text-decoration: line-through;
         color: grey;
      }
      #ergebnisTabelle .sync-status {
        font-size: 0.8em;
        color: #666;
        display: block; /* Eigene Zeile für Status */
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Schützenverein - Ergebnisse erfassen</h1>
    </header>
    <div class="container">
      <!-- Navigation Platzhalter -->
      <div id="navigation-placeholder"></div>
      <main>
        <h2>Neues Ergebnis erfassen / Bearbeiten</h2>
        <form id="ergebnisForm">
          <input type="hidden" id="editLocalId" />

          <!-- Team Auswahl zuerst (optional, aber vielleicht logischer?) -->
          <label for="teamSelect">Team (optional):</label>
          <select id="teamSelect">
            <option value="">-- Kein Team --</option>
          </select>

          <label for="teilnehmerSelect">Teilnehmer:</label>
          <select id="teilnehmerSelect" required>
            <option value="">-- Bitte wählen --</option>
            <!-- Optionen werden dynamisch gefiltert -->
          </select>

          <label for="ringzahl">Ringzahl:</label>
          <input type="number" id="ringzahl" required min="0" />

          <label for="bemerkung">Bemerkung (optional):</label>
          <input type="text" id="bemerkung" />

          <button type="submit" class="btn btn-primary">Speichern</button>
          <button type="button" id="cancelEditBtn" class="btn" style="display: none">
            Abbrechen
          </button>
        </form>

        <div id="statusMeldung" class="status-meldung"></div>

        <div id="confirmModal" class="modal">
          <div class="modal-content">
            <p id="confirmModalText">Möchtest du das wirklich tun?</p>
            <button id="confirmModalOk" class="btn btn-danger">Ja</button>
            <button id="confirmModalCancel" class="btn">Abbrechen</button>
          </div>
        </div>

        <h3>Gespeicherte Ergebnisse:</h3>
        <table id="ergebnisTabelle">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Teilnehmer</th>
                    <th>Team</th>
                    <th>Ringe</th>
                    <th>Bemerkung</th>
                    <th>Status</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody id="ergebnisListe">
            </tbody>
        </table>
      </main>
    </div>

    <script type="module">
      // UI Utils Imports
      import { zeigeStatus, zeigeConfirm } from "./ui-utils.js";

      // Local Storage Utils Imports
      import {
        getLocalData,
        setLocalData,
        generateLocalId,
        ERGEBNISSE_KEY,
        getActiveTeilnehmer,
        getActiveTeams,
        getActiveErgebnisse,
        createTeilnehmerMap,
        createTeamMap,
      } from "./local-storage-utils.js";

      const ergebnisForm = document.getElementById("ergebnisForm");
      const teilnehmerSelect = document.getElementById("teilnehmerSelect");
      const teamSelect = document.getElementById("teamSelect");
      const ringzahlInput = document.getElementById("ringzahl");
      const bemerkungInput = document.getElementById("bemerkung");
      const ergebnisListe = document.getElementById("ergebnisListe");
      const editLocalIdInput = document.getElementById("editLocalId");
      const cancelEditBtn = document.getElementById("cancelEditBtn");

      // Globale Variablen für Daten und Maps
      let teilnehmerMap = new Map();
      let teamMap = new Map();
      let aktiveTeilnehmer = []; // NEU: Globale Liste der aktiven Teilnehmer

      // Laden der initialen Daten (Teilnehmer, Teams)
      function loadInitialData() {
        // NEU: Aktive Teilnehmer in globaler Variable speichern
        aktiveTeilnehmer = getActiveTeilnehmer();
        const teams = getActiveTeams();

        // Teilnehmer-Dropdown initial mit allen füllen
        populateTeilnehmerDropdown(); // NEU: Aufruf der Hilfsfunktion

        // Team-Dropdown füllen
        teamSelect.innerHTML = '<option value="">-- Kein Team --</option>';
        teams.forEach((t) => {
          const option = document.createElement("option");
          option.value = t.localId;
          option.textContent = t.teamname || "Unbenanntes Team";
          teamSelect.appendChild(option);
        });

        // Maps erstellen
        teilnehmerMap = createTeilnehmerMap(aktiveTeilnehmer); // Nutzt jetzt globale Liste
        teamMap = createTeamMap(teams);
      }

      // NEU: Hilfsfunktion zum Füllen des Teilnehmer-Dropdowns
      /**
       * Füllt das Teilnehmer-Dropdown, optional gefiltert nach Teammitgliedern.
       * @param {Set<string>|null} [filterMitgliederIds=null] Ein Set mit localIds der anzuzeigenden Teilnehmer. Wenn null, werden alle angezeigt.
       */
      function populateTeilnehmerDropdown(filterMitgliederIds = null) {
          const currentSelectedValue = teilnehmerSelect.value; // Aktuell ausgewählten Wert merken
          teilnehmerSelect.innerHTML = '<option value="">-- Bitte wählen --</option>'; // Reset

          aktiveTeilnehmer.forEach((t) => {
              // Wenn gefiltert werden soll, prüfe ob Teilnehmer im Set ist
              if (!filterMitgliederIds || filterMitgliederIds.has(t.localId)) {
                  const option = document.createElement("option");
                  option.value = t.localId;
                  option.textContent = `${t.vorname || ""} ${t.name || ""}`.trim();
                  teilnehmerSelect.appendChild(option);
              }
          });

          // Versuche, den vorher ausgewählten Wert wiederherzustellen, falls er noch gültig ist
          if (teilnehmerSelect.querySelector(`option[value="${currentSelectedValue}"]`)) {
              teilnehmerSelect.value = currentSelectedValue;
          } else {
              teilnehmerSelect.value = ""; // Ansonsten auf "Bitte wählen" zurücksetzen
          }
      }

      // Ergebnisse anzeigen - unverändert
      function displayErgebnisseFromLocal() {
        const lokaleErgebnisse = getActiveErgebnisse();
        ergebnisListe.innerHTML = "";

        if (lokaleErgebnisse.length === 0) {
          const row = ergebnisListe.insertRow();
          const cell = row.insertCell();
          cell.colSpan = 7;
          cell.textContent = "Noch keine Ergebnisse lokal gespeichert.";
          return;
        }

        lokaleErgebnisse.forEach((ergebnis) => {
          const row = ergebnisListe.insertRow();
          row.dataset.localId = ergebnis.localId;
          row.dataset.syncStatus = ergebnis._syncStatus;

          const teilnehmer = teilnehmerMap.get(ergebnis.teilnehmerLocalId);
          const team = ergebnis.teamLocalId ? teamMap.get(ergebnis.teamLocalId) : null;

          const teilnehmerName = teilnehmer ? `${teilnehmer.vorname || ""} ${teilnehmer.name || ""}`.trim() : "Unbekannt";
          const teamName = team ? (team.teamname || "Unbekannt") : "-";
          const ringe = ergebnis.ringzahl ?? "N/A";
          const bemerkung = ergebnis.bemerkung || "-";
          const datum = ergebnis.createdAt ? new Date(ergebnis.createdAt).toLocaleString("de-DE", { dateStyle: 'short', timeStyle: 'short'}) : "-";

          let syncStatusText = "";
          let statusKurz = "";
          if (ergebnis._syncStatus === "new") {
            syncStatusText = "Neu, nicht synchronisiert"; statusKurz = "Neu";
          } else if (ergebnis._syncStatus === "modified") {
            syncStatusText = "Geändert, nicht synchronisiert"; statusKurz = "Geändert";
          } else if (ergebnis._syncStatus === "deleted") {
            syncStatusText = "Wird beim nächsten Sync gelöscht"; statusKurz = "Gelöscht"; row.classList.add("deleted");
          } else {
             syncStatusText = "Synchronisiert"; statusKurz = "Synced";
          }

          row.insertCell().textContent = datum;
          row.insertCell().textContent = teilnehmerName;
          row.insertCell().textContent = teamName;
          row.insertCell().textContent = ringe;
          row.insertCell().textContent = bemerkung;
          const statusCell = row.insertCell();
          statusCell.innerHTML = `<span class="sync-status" title="${syncStatusText}">${statusKurz}</span>`;
          const actionsCell = row.insertCell();
          actionsCell.classList.add('actions-cell');
          actionsCell.innerHTML = `
            <button class="edit-btn btn btn-secondary" data-local-id="${ergebnis.localId}">Edit</button>
            <button class="delete-btn btn btn-danger" data-local-id="${ergebnis.localId}">X</button>
          `;
        });
      }

      // Ergebnis speichern oder aktualisieren - unverändert
      function saveOrUpdateErgebnisLokal(e) {
        e.preventDefault();
        const editLocalId = editLocalIdInput.value;
        const teilnehmerLocalId = teilnehmerSelect.value;
        const teamLocalId = teamSelect.value || null;
        const ringzahl = parseInt(ringzahlInput.value, 10);
        const bemerkung = bemerkungInput.value.trim();

        if (!teilnehmerLocalId || isNaN(ringzahl)) {
          zeigeStatus("Bitte Teilnehmer auswählen und Ringzahl angeben.", "fehler");
          return;
        }

        // NEU: Zusätzliche Prüfung, ob der ausgewählte Teilnehmer zum ausgewählten Team passt
        if (teamLocalId) {
            const team = teamMap.get(teamLocalId);
            if (team && team.mitglieder && !team.mitglieder.includes(teilnehmerLocalId)) {
                 zeigeStatus(`Fehler: Teilnehmer "${teilnehmerMap.get(teilnehmerLocalId)?.name || teilnehmerLocalId}" ist nicht Mitglied im ausgewählten Team "${team.teamname || teamLocalId}". Bitte korrigieren.`, "fehler", 5000);
                 return; // Speichern verhindern
            }
        }
        // Ende NEU

        const alleErgebnisse = getLocalData(ERGEBNISSE_KEY);
        let status = "erfolg";
        let message = "";

        if (editLocalId) {
          // Bearbeiten
          const index = alleErgebnisse.findIndex((e) => e.localId === editLocalId);
          if (index > -1) {
            const existingErgebnis = alleErgebnisse[index];
            if (
              existingErgebnis.teilnehmerLocalId !== teilnehmerLocalId ||
              existingErgebnis.teamLocalId !== teamLocalId ||
              existingErgebnis.ringzahl !== ringzahl ||
              existingErgebnis.bemerkung !== bemerkung
            ) {
              existingErgebnis.teilnehmerLocalId = teilnehmerLocalId;
              existingErgebnis.teamLocalId = teamLocalId;
              existingErgebnis.ringzahl = ringzahl;
              existingErgebnis.bemerkung = bemerkung;
              existingErgebnis.lastModifiedLocal = new Date().toISOString();
              if (existingErgebnis._syncStatus !== "new") {
                existingErgebnis._syncStatus = "modified";
              }
              message = "Ergebnis lokal aktualisiert.";
            } else {
              message = "Keine Änderungen am Ergebnis vorgenommen.";
              status = "info";
            }
          } else {
            message = "Fehler: Zu bearbeitendes Ergebnis nicht gefunden!";
            status = "fehler";
          }
        } else {
          // Neu hinzufügen
          const neuesErgebnis = {
            localId: generateLocalId(),
            firestoreId: null,
            teilnehmerLocalId: teilnehmerLocalId,
            teamLocalId: teamLocalId,
            ringzahl: ringzahl,
            bemerkung: bemerkung,
            createdAt: new Date().toISOString(),
            _syncStatus: "new",
          };
          alleErgebnisse.push(neuesErgebnis);
          message = "Ergebnis lokal hinzugefügt.";
        }

        if (status !== "fehler") {
          const success = setLocalData(ERGEBNISSE_KEY, alleErgebnisse);
          if (!success) {
            message = "Fehler beim lokalen Speichern des Ergebnisses!";
            status = "fehler";
          }
        }

        zeigeStatus(message, status);

        if (status !== "fehler") {
          resetForm();
          displayErgebnisseFromLocal();
        }
      }

      // Formular zurücksetzen - unverändert
      function resetForm() {
        ergebnisForm.reset();
        editLocalIdInput.value = "";
        cancelEditBtn.style.display = "none";
        // NEU: Teilnehmer-Dropdown wieder mit allen füllen, wenn Formular zurückgesetzt wird
        populateTeilnehmerDropdown();
        teilnehmerSelect.disabled = false;
        teamSelect.disabled = false;
      }

      // Ergebnis zum Bearbeiten laden - unverändert
      function loadErgebnisForEdit(localId) {
        const alleErgebnisse = getLocalData(ERGEBNISSE_KEY);
        const ergebnis = alleErgebnisse.find((e) => e.localId === localId);

        if (ergebnis) {
          editLocalIdInput.value = ergebnis.localId;
          teamSelect.value = ergebnis.teamLocalId || ""; // Team zuerst setzen

          // NEU: Teilnehmer-Dropdown basierend auf dem geladenen Team filtern
          const team = ergebnis.teamLocalId ? teamMap.get(ergebnis.teamLocalId) : null;
          const mitgliederIds = team ? new Set(team.mitglieder || []) : null;
          populateTeilnehmerDropdown(mitgliederIds);

          // Erst *nach* dem Filtern den Teilnehmer auswählen
          teilnehmerSelect.value = ergebnis.teilnehmerLocalId;

          ringzahlInput.value = ergebnis.ringzahl ?? "";
          bemerkungInput.value = ergebnis.bemerkung || "";

          cancelEditBtn.style.display = "inline-block";
          window.scrollTo(0, 0);
        } else {
          zeigeStatus("Zu bearbeitendes Ergebnis nicht gefunden.", "fehler");
        }
      }

      // Ergebnis löschen (LOKAL markieren) - unverändert
      function deleteErgebnisLokal(localId) {
        zeigeConfirm("Möchtest du dieses Ergebnis wirklich löschen?", () => {
          const alleErgebnisse = getLocalData(ERGEBNISSE_KEY);
          const index = alleErgebnisse.findIndex((e) => e.localId === localId);

          if (index > -1) {
            let message = "";
            let status = "erfolg";
            if (alleErgebnisse[index]._syncStatus === "new") {
              alleErgebnisse.splice(index, 1);
              message = "Ergebnis lokal entfernt (war noch nicht synchronisiert).";
            } else {
              alleErgebnisse[index]._syncStatus = "deleted";
              message = "Ergebnis zum Löschen markiert (wird beim nächsten Sync entfernt).";
            }
            const success = setLocalData(ERGEBNISSE_KEY, alleErgebnisse);
            if (success) {
              displayErgebnisseFromLocal();
            } else {
              message = "Fehler beim lokalen Speichern der Löschmarkierung!";
              status = "fehler";
            }
            zeigeStatus(message, status);
          } else {
            zeigeStatus("Zu löschendes Ergebnis nicht gefunden.", "fehler");
          }
        });
      }

      // Event Listener
      ergebnisForm.addEventListener("submit", saveOrUpdateErgebnisLokal);
      cancelEditBtn.addEventListener("click", resetForm);

      ergebnisListe.addEventListener("click", (e) => {
        const editButton = e.target.closest(".edit-btn");
        const deleteButton = e.target.closest(".delete-btn");

        if (editButton) {
          e.stopPropagation();
          const localId = editButton.getAttribute("data-local-id");
          loadErgebnisForEdit(localId);
        } else if (deleteButton) {
          e.stopPropagation();
          const localId = deleteButton.getAttribute("data-local-id");
          deleteErgebnisLokal(localId);
        }
      });

      // NEU: Event Listener für Team-Auswahl
      teamSelect.addEventListener('change', (event) => {
          const selectedTeamLocalId = event.target.value;
          if (selectedTeamLocalId) {
              const team = teamMap.get(selectedTeamLocalId);
              const mitgliederIds = team ? new Set(team.mitglieder || []) : null;
              populateTeilnehmerDropdown(mitgliederIds);
          } else {
              // Kein Team ausgewählt -> alle Teilnehmer anzeigen
              populateTeilnehmerDropdown();
          }
      });

      // Initialisierung
      document.addEventListener("DOMContentLoaded", () => {
        loadInitialData();
        displayErgebnisseFromLocal();

        window.addEventListener('datasync-complete', (event) => {
            if (event.detail?.success && event.detail?.changesMade) { // Nur neu laden, wenn sich was geändert hat
                console.log("Daten neu laden nach erfolgreichem Sync...");
                // Wichtig: loadInitialData lädt alles neu, inkl. Dropdowns
                loadInitialData();
                displayErgebnisseFromLocal();
            }
        });
      });
    </script>
  </body>
</html>
