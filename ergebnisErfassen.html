<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ergebnisse erfassen (Offline-First)</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Zentrales Auto-Sync Skript einbinden -->
    <script type="module" src="auto-sync.js" defer></script>
    <!-- NEU: Skript zum Laden der Navigation einbinden -->
    <script src="load-nav.js" defer></script>
  </head>
  <body>
    <header>
      <h1>Schützenverein - Ergebnisse erfassen</h1>
    </header>
    <div class="container">
      <!-- ERSETZT: Der alte <nav>-Block wird durch diesen Platzhalter ersetzt -->
      <div id="navigation-placeholder">
        <!-- Die Navigation wird hier von load-nav.js eingefügt -->
      </div>
      <main>
        <h2>Neues Ergebnis erfassen / Bearbeiten</h2>
        <form id="ergebnisForm">
          <input type="hidden" id="editLocalId" />
          <!-- Verstecktes Feld für die ID beim Bearbeiten -->

          <label for="teilnehmerSelect">Teilnehmer:</label>
          <select id="teilnehmerSelect" required>
            <option value="">-- Bitte wählen --</option>
            <!-- Optionen werden dynamisch geladen -->
          </select>

          <label for="teamSelect">Team (optional):</label>
          <select id="teamSelect">
            <option value="">-- Kein Team --</option>
            <!-- Optionen werden dynamisch geladen -->
          </select>

          <label for="ringzahl">Ringzahl:</label>
          <input type="number" id="ringzahl" required min="0" />

          <label for="teiler">Teiler (optional):</label>
          <input type="number" id="teiler" step="0.1" min="0" />

          <label for="bemerkung">Bemerkung (optional):</label>
          <input type="text" id="bemerkung" />

          <button type="submit" class="btn btn-primary">Speichern</button>
          <button type="button" id="cancelEditBtn" class="btn" style="display: none">
            Abbrechen
          </button>
        </form>

        <div id="statusMeldung" class="status-meldung"></div>

        <div id="confirmModal" class="modal">
          <div class="modal-content">
            <p id="confirmModalText">Möchtest du das wirklich tun?</p>
            <button id="confirmModalOk" class="btn btn-danger">Ja</button>
            <button id="confirmModalCancel" class="btn">Abbrechen</button>
          </div>
        </div>

        <h3>Gespeicherte Ergebnisse:</h3>
        <ul id="ergebnisListe"></ul>
      </main>
    </div>

    <script type="module">
      // UI Utils Imports
      import { zeigeStatus, zeigeConfirm } from "./ui-utils.js";

      // Local Storage Utils Imports
      import {
        getLocalData, // Wird noch für save/update benötigt
        setLocalData,
        generateLocalId,
        TEILNEHMER_KEY, // Wird nicht mehr direkt benötigt, aber schadet nicht
        TEAMS_KEY,      // Wird nicht mehr direkt benötigt, aber schadet nicht
        ERGEBNISSE_KEY,
        // NEUE IMPORTE:
        getActiveTeilnehmer,
        getActiveTeams,
        getActiveErgebnisse,
        createTeilnehmerMap,
        createTeamMap,
      } from "./local-storage-utils.js";

      const ergebnisForm = document.getElementById("ergebnisForm");
      const teilnehmerSelect = document.getElementById("teilnehmerSelect");
      const teamSelect = document.getElementById("teamSelect");
      const ringzahlInput = document.getElementById("ringzahl");
      const teilerInput = document.getElementById("teiler");
      const bemerkungInput = document.getElementById("bemerkung");
      const ergebnisListe = document.getElementById("ergebnisListe");
      const editLocalIdInput = document.getElementById("editLocalId");
      const cancelEditBtn = document.getElementById("cancelEditBtn");

      // --- Globale Variablen für Daten und Maps ---
      let teilnehmerMap = new Map();
      let teamMap = new Map();

      // --- Laden der initialen Daten (Teilnehmer, Teams) ---
      function loadInitialData() {
        // NEU: Verwende die neuen Hilfsfunktionen
        const teilnehmer = getActiveTeilnehmer();
        const teams = getActiveTeams();

        // Teilnehmer-Dropdown füllen
        teilnehmerSelect.innerHTML =
          '<option value="">-- Bitte wählen --</option>'; // Reset
        teilnehmer.forEach((t) => {
          const option = document.createElement("option");
          option.value = t.localId;
          option.textContent = `${t.vorname || ""} ${t.name || ""}`.trim();
          teilnehmerSelect.appendChild(option);
        });

        // Team-Dropdown füllen
        teamSelect.innerHTML = '<option value="">-- Kein Team --</option>'; // Reset
        teams.forEach((t) => {
          const option = document.createElement("option");
          option.value = t.localId;
          option.textContent = t.teamname || "Unbenanntes Team";
          teamSelect.appendChild(option);
        });

        // NEU: Maps mit den neuen Hilfsfunktionen erstellen
        teilnehmerMap = createTeilnehmerMap(teilnehmer);
        teamMap = createTeamMap(teams);
      }

      // --- Ergebnisse aus Local Storage anzeigen ---
      function displayErgebnisseFromLocal() {
        // NEU: Verwende die neue Hilfsfunktion
        const lokaleErgebnisse = getActiveErgebnisse(); // Holt aktive und sortierte Ergebnisse

        ergebnisListe.innerHTML = ""; // Liste leeren

        if (lokaleErgebnisse.length === 0) {
          ergebnisListe.innerHTML =
            "<li>Noch keine Ergebnisse lokal gespeichert.</li>";
          return;
        }

        lokaleErgebnisse.forEach((ergebnis) => {
          const li = document.createElement("li");
          const teilnehmer = teilnehmerMap.get(ergebnis.teilnehmerLocalId);
          const team = ergebnis.teamLocalId ? teamMap.get(ergebnis.teamLocalId) : null;

          const teilnehmerName = teilnehmer
            ? `${teilnehmer.vorname || ""} ${teilnehmer.name || ""}`.trim()
            : "Unbekannter Teilnehmer";
          const teamName = team ? ` (Team: ${team.teamname || "Unbekannt"})` : "";
          const ringe = ergebnis.ringzahl ?? "N/A"; // Nullish coalescing
          const teiler = ergebnis.teiler ? ` / Teiler: ${ergebnis.teiler}` : "";
          const bemerkung = ergebnis.bemerkung ? ` - ${ergebnis.bemerkung}` : "";
          const datum = ergebnis.createdAt
            ? new Date(ergebnis.createdAt).toLocaleString("de-DE")
            : "Unbekanntes Datum";

          let syncStatusText = "";
          if (ergebnis._syncStatus === "new") {
            syncStatusText =
              '<span class="sync-status">(Neu, nicht synchronisiert)</span>';
          } else if (ergebnis._syncStatus === "modified") {
            syncStatusText =
              '<span class="sync-status">(Geändert, nicht synchronisiert)</span>';
          } else if (ergebnis._syncStatus === "deleted") {
            // Sollte hier nicht mehr vorkommen, da getActiveErgebnisse filtert
            syncStatusText =
              '<span class="sync-status">(Wird beim nächsten Sync gelöscht)</span>';
            li.classList.add("deleted");
          }

          li.innerHTML = `
                    <span>${datum}: ${teilnehmerName}${teamName} - Ringe: ${ringe}${teiler}${bemerkung}</span>
                    ${syncStatusText}
                    <button class="edit-btn" data-local-id="${ergebnis.localId}">Bearbeiten</button>
                    <button class="delete-btn" data-local-id="${ergebnis.localId}">Löschen</button>
                `;
          li.dataset.localId = ergebnis.localId;
          li.dataset.syncStatus = ergebnis._syncStatus;
          ergebnisListe.appendChild(li);
        });
      }

      // --- Ergebnis speichern oder aktualisieren (LOKAL) ---
      function saveOrUpdateErgebnisLokal(e) {
        e.preventDefault();
        const editLocalId = editLocalIdInput.value; // ID holen, falls wir im Edit-Modus sind

        const teilnehmerLocalId = teilnehmerSelect.value;
        const teamLocalId = teamSelect.value || null; // Leerer String wird zu null
        const ringzahl = parseInt(ringzahlInput.value, 10);
        const teiler = teilerInput.value ? parseFloat(teilerInput.value) : null;
        const bemerkung = bemerkungInput.value.trim();

        if (!teilnehmerLocalId || isNaN(ringzahl)) {
          zeigeStatus(
            "Bitte Teilnehmer auswählen und Ringzahl angeben.",
            "fehler"
          );
          return;
        }

        const alleErgebnisse = getLocalData(ERGEBNISSE_KEY); // Hier brauchen wir alle, auch die gelöschten
        let status = "erfolg";
        let message = "";

        if (editLocalId) {
          // --- Bearbeiten ---
          const index = alleErgebnisse.findIndex(
            (e) => e.localId === editLocalId
          );
          if (index > -1) {
            const existingErgebnis = alleErgebnisse[index];
            // Prüfen, ob sich wirklich etwas geändert hat
            if (
              existingErgebnis.teilnehmerLocalId !== teilnehmerLocalId ||
              existingErgebnis.teamLocalId !== teamLocalId ||
              existingErgebnis.ringzahl !== ringzahl ||
              existingErgebnis.teiler !== teiler ||
              existingErgebnis.bemerkung !== bemerkung
            ) {
              existingErgebnis.teilnehmerLocalId = teilnehmerLocalId;
              existingErgebnis.teamLocalId = teamLocalId;
              existingErgebnis.ringzahl = ringzahl;
              existingErgebnis.teiler = teiler;
              existingErgebnis.bemerkung = bemerkung;
              existingErgebnis.lastModifiedLocal = new Date().toISOString(); // Zeitstempel der lokalen Änderung

              // Status nur auf 'modified' setzen, wenn es nicht schon 'new' war
              if (existingErgebnis._syncStatus !== "new") {
                existingErgebnis._syncStatus = "modified";
              }
              message = "Ergebnis lokal aktualisiert.";
            } else {
              message = "Keine Änderungen am Ergebnis vorgenommen.";
              status = "info"; // Keine Erfolgsmeldung, nur Info
            }
          } else {
            message = "Fehler: Zu bearbeitendes Ergebnis nicht gefunden!";
            status = "fehler";
          }
        } else {
          // --- Neu hinzufügen ---
          const neuesErgebnis = {
            localId: generateLocalId(),
            firestoreId: null,
            teilnehmerLocalId: teilnehmerLocalId,
            teamLocalId: teamLocalId,
            ringzahl: ringzahl,
            teiler: teiler,
            bemerkung: bemerkung,
            createdAt: new Date().toISOString(), // Lokaler Zeitstempel der Erstellung
            _syncStatus: "new",
          };
          alleErgebnisse.push(neuesErgebnis);
          message = "Ergebnis lokal hinzugefügt.";
        }

        // Nur speichern, wenn Status nicht 'fehler' ist
        if (status !== "fehler") {
          const success = setLocalData(ERGEBNISSE_KEY, alleErgebnisse);
          if (!success) {
            message = "Fehler beim lokalen Speichern des Ergebnisses!";
            status = "fehler";
          }
        }

        zeigeStatus(message, status);

        if (status !== "fehler") {
          resetForm();
          displayErgebnisseFromLocal(); // Liste aktualisieren
        }
      }

      // --- Formular zurücksetzen ---
      function resetForm() {
        ergebnisForm.reset();
        editLocalIdInput.value = ""; // Verstecktes Feld leeren
        cancelEditBtn.style.display = "none"; // Abbrechen-Button ausblenden
        teilnehmerSelect.disabled = false; // Auswahl wieder aktivieren
        teamSelect.disabled = false;
      }

      // --- Ergebnis zum Bearbeiten laden ---
      function loadErgebnisForEdit(localId) {
        const alleErgebnisse = getLocalData(ERGEBNISSE_KEY);
        const ergebnis = alleErgebnisse.find((e) => e.localId === localId);

        if (ergebnis) {
          editLocalIdInput.value = ergebnis.localId;
          teilnehmerSelect.value = ergebnis.teilnehmerLocalId;
          teamSelect.value = ergebnis.teamLocalId || "";
          ringzahlInput.value = ergebnis.ringzahl ?? "";
          teilerInput.value = ergebnis.teiler ?? "";
          bemerkungInput.value = ergebnis.bemerkung || "";

          // Optional: Teilnehmer/Team-Auswahl sperren, wenn Bearbeitung nicht erlaubt sein soll
          // teilnehmerSelect.disabled = true;
          // teamSelect.disabled = true;

          cancelEditBtn.style.display = "inline-block"; // Abbrechen-Button anzeigen
          window.scrollTo(0, 0); // Nach oben scrollen zum Formular
        } else {
          zeigeStatus("Zu bearbeitendes Ergebnis nicht gefunden.", "fehler");
        }
      }

      // --- Ergebnis löschen (LOKAL markieren) ---
      function deleteErgebnisLokal(localId) {
        zeigeConfirm("Möchtest du dieses Ergebnis wirklich löschen?", () => {
          const alleErgebnisse = getLocalData(ERGEBNISSE_KEY);
          const index = alleErgebnisse.findIndex((e) => e.localId === localId);

          if (index > -1) {
            let message = "";
            let status = "erfolg";

            // Wenn das Ergebnis noch nie synchronisiert wurde ('new'), direkt entfernen
            if (alleErgebnisse[index]._syncStatus === "new") {
              alleErgebnisse.splice(index, 1);
              message =
                "Ergebnis lokal entfernt (war noch nicht synchronisiert).";
            } else {
              // Ansonsten zum Löschen markieren
              alleErgebnisse[index]._syncStatus = "deleted";
              message =
                "Ergebnis zum Löschen markiert (wird beim nächsten Sync entfernt).";
            }

            const success = setLocalData(ERGEBNISSE_KEY, alleErgebnisse);
            if (success) {
              displayErgebnisseFromLocal(); // Liste neu anzeigen
            } else {
              message = "Fehler beim lokalen Speichern der Löschmarkierung!";
              status = "fehler";
            }
            zeigeStatus(message, status);
          } else {
            zeigeStatus("Zu löschendes Ergebnis nicht gefunden.", "fehler");
          }
        });
      }

      // --- Event Listener ---
      ergebnisForm.addEventListener("submit", saveOrUpdateErgebnisLokal);
      cancelEditBtn.addEventListener("click", resetForm);

      ergebnisListe.addEventListener("click", (e) => {
        const editButton = e.target.closest(".edit-btn");
        const deleteButton = e.target.closest(".delete-btn");

        if (editButton) {
          e.stopPropagation();
          const localId = editButton.getAttribute("data-local-id");
          loadErgebnisForEdit(localId);
        } else if (deleteButton) {
          e.stopPropagation();
          const localId = deleteButton.getAttribute("data-local-id");
          deleteErgebnisLokal(localId);
        }
      });

      // --- Initialisierung ---
      document.addEventListener("DOMContentLoaded", () => {
        loadInitialData(); // Teilnehmer/Teams laden
        displayErgebnisseFromLocal(); // Gespeicherte Ergebnisse anzeigen

        // Event Listener für Sync-Abschluss (optional, um Liste neu zu laden)
        window.addEventListener('datasync-complete', (event) => {
            console.log("Event 'datasync-complete' empfangen in ergebnisErfassen.html");
            // Prüfen, ob der Sync erfolgreich war und Änderungen gemacht hat
            if (event.detail?.success) {
                console.log("Daten neu laden nach erfolgreichem Sync...");
                loadInitialData(); // Teilnehmer/Teams könnten sich geändert haben
                displayErgebnisseFromLocal(); // Ergebnisse neu anzeigen
            }
        });
      });
    </script>
  </body>
</html>
